from federatedml.nn.homo_nn.nn_model import get_nn_builder
import json
import tensorflow as tf
from federatedml.param.ftl_param import FTLParam
import numpy as np
from numpy import array
from arch.api.session import init
from arch.api import session
from federatedml.hetero_ftl.ftl_dataloder import FTLDataLoader
import pandas as pd

from federatedml.protobuf.generated.ftl_model_param_pb2 import FTLModelParam
from federatedml.protobuf.generated.ftl_model_meta_pb2 import FTLModelMeta

from federatedml.nn.hetero_nn.backend.tf_keras.data_generator import KerasSequenceDataConverter

session.init("test", 0)

nn_builder = get_nn_builder(config_type='keras')

grads = [[-1.658951543609012, -1.658951543609012], [-1.1615836400188098, -1.1615836400188098], [0.8751972842610964, 0.8751972842610964], [0.7949859726823458, 0.7949859726823458], [1.0796980488694796, 1.0796980488694796], [-1.6589299071229586, -1.6589299071229586], [1.1474279094136843, 1.1474279094136843], [-1.3069952953256259, -1.3069952953256259], [-1.6016224849618563, -1.6016224849618563], [1.1588480848468432, 1.1588480848468432], [1.12869455699097, 1.12869455699097], [1.1578282791770587, 1.1578282791770587], [-1.6538909006513247, -1.6538909006513247], [-1.2434961873687396, -1.2434961873687396], [1.1260551441110263, 1.1260551441110263], [-1.6533313620484957, -1.6533313620484957], [0.8579851913846621, 0.8579851913846621], [-1.1599344242013583, -1.1599344242013583], [-1.366305642167438, -1.366305642167438], [1.11442730609547, 1.11442730609547], [1.1588500816024432, 1.1588500816024432], [-1.1592808294690737, -1.1592808294690737], [0.6698930192388186, 0.6698930192388186], [-1.3663896102107653, -1.3663896102107653], [-1.658946536818851, -1.658946536818851], [-1.6589416790403018, -1.6589416790403018], [1.153742723504413, 1.153742723504413], [1.1573032218612322, 1.1573032218612322], [-1.6589490998185763, -1.6589490998185763], [-1.65891095284592, -1.65891095284592], [-1.6589354801572451, -1.6589354801572451], [-1.6504082906640658, -1.6504082906640658], [1.1301268864072451, 1.1301268864072451], [-1.5919971096910128, -1.5919971096910128], [-1.2604501027263293, -1.2604501027263293], [-1.159471027890552, -1.159471027890552], [0.6760660338796267, 0.6760660338796267], [-1.32313533906113, -1.32313533906113], [-1.6589505899346957, -1.6589505899346957], [1.1212083477176318, 1.1212083477176318], [-1.658915095368732, -1.658915095368732], [1.1471084434188494, 1.1471084434188494], [-1.172858782450069, -1.172858782450069], [-1.1672020036376605, -1.1672020036376605], [0.7504279244340548, 0.7504279244340548], [0.6589922237790713, 0.6589922237790713], [-1.173215233126987, -1.173215233126987], [1.1524574983514437, 1.1524574983514437], [1.1589221702643524, 1.1589221702643524], [-1.5942096341050753, -1.5942096341050753], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012], [-1.158951543609012, -1.158951543609012], [-1.158951543609012, -1.158951543609012], [1.158951543609012, 1.158951543609012]]
grads = np.array(grads)

grads_128 = [array([-3.15895154, -3.15895154]), array([-1.16947993, -1.16947993]), array([0.02393451, 0.02393451]), array([-0.29691074, -0.29691074]), array([0.84193756, 0.84193756]), array([-3.158865, -3.158865]), array([1.11285701, 1.11285701]), array([-1.75112655, -1.75112655]), array([-2.92963531, -2.92963531]), array([1.15853771, 1.15853771]), array([1.0379236, 1.0379236]), array([1.15445849, 1.15445849]), array([-3.13870897, -3.13870897]), array([-1.49713012, -1.49713012]), array([1.02736595, 1.02736595]), array([-3.13647082, -3.13647082]), array([-0.04491387, -0.04491387]), array([-1.16288307, -1.16288307]), array([-1.98836794, -1.98836794]), array([0.98085459, 0.98085459]), array([1.1585457, 1.1585457]), array([-1.16026869, -1.16026869]), array([-0.79728255, -0.79728255]), array([-1.98870381, -1.98870381]), array([-3.15893152, -3.15893152]), array([-3.15891209, -3.15891209]), array([1.13811626, 1.13811626]), array([1.15235826, 1.15235826]), array([-3.15894177, -3.15894177]), array([-3.15878918, -3.15878918]), array([-3.15888729, -3.15888729]), array([-3.12477853, -3.12477853]), array([1.04365291, 1.04365291]), array([-2.89113381, -2.89113381]), array([-1.56494578, -1.56494578]), array([-1.16102948, -1.16102948]), array([-0.7725905, -0.7725905]), array([-1.81568673, -1.81568673]), array([-3.15894773, -3.15894773]), array([1.00797876, 1.00797876]), array([-3.15880575, -3.15880575]), array([1.11157914, 1.11157914]), array([-1.2145805, -1.2145805]), array([-1.19195338, -1.19195338]), array([-0.47514293, -0.47514293]), array([-0.84088574, -0.84088574]), array([-1.2160063, -1.2160063]), array([1.13297536, 1.13297536]), array([1.15883405, 1.15883405]), array([-2.89998391, -2.89998391]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154]), array([-1.15895154, -1.15895154]), array([-1.15895154, -1.15895154]), array([1.15895154, 1.15895154])]
grads_128 = np.array(grads_128)

loss = "keep_predict_loss"
nn_define = json.loads('{"class_name": "Sequential", "config": {"name": "sequential_1", "layers": [{"class_name": "Dense", "config": {"name": "dense_1", "trainable": true, "batch_input_shape": [null, 32], "dtype": "float32", "units": 2, "activation": "sigmoid", "use_bias": true, "kernel_initializer": {"class_name": "Constant", "config": {"value": 1, "dtype": "float32"}}, "bias_initializer": {"class_name": "Zeros", "config": {"dtype": "float32"}}, "kernel_regularizer": null, "bias_regularizer": null, "activity_regularizer": null, "kernel_constraint": null, "bias_constraint": null}}]}, "keras_version": "2.2.4-tf", "backend": "tensorflow"}')
NNModel = nn_builder(loss=loss, nn_define=nn_define, optimizer=FTLParam()._parse_optimizer({'optimizer': 'Adam'}), metrics=None, input_shape=10)

df = pd.read_csv('../../../examples/data/ftl_test_b.csv')
fake_data = df[[str(i) for i in range(10)]].to_numpy()

# sample_num = 1000
# fake_data = np.ones((sample_num, 2))
# rs = NNModel.predict(fake_data)
# fake_grads = np.ones((sample_num, 2))

grad = grads

batch_size = 128

grads_1 = NNModel.get_weight_gradients(fake_data, grad)

grads_2 = []

for i in range(len(fake_data) // batch_size + 1):
    data_batch = fake_data[i*batch_size:(i+1)*batch_size]
    batch_grads = grad[i*batch_size:(i+1)*batch_size]

    grad_part = NNModel.get_weight_gradients(data_batch, batch_grads)
    if len(grads_2) == 0:
        grads_2.extend(grad_part)
    else:
        for w, w_ in zip(grads_2, grad_part):
            w += w_

# for i in range(len(grads_1)):
#     grads_1[i] /= len(fake_data)
#
# for i in range(len(grads_2)):
#     grads_2[i] /= len(fake_data)

print(NNModel.get_trainable_weights())

print('update mode 1')
data_converter = KerasSequenceDataConverter()
# NNModel.train(data_converter.convert_data(fake_data[0:100], grads[0:100]))

# print('update mode 2')
# NNModel.apply_gradients(grads_1)

print(NNModel.get_trainable_weights())



#
# param = FTLModelParam()
# param.model_bytes = NNModel.export_model()
# rs = NNModel.predict(fake_data).sum(axis=0) / len(fake_data)
# phi = rs.tolist()
# param.phi_a.extend(phi)
#
# NNModel.restore_model(param.model_bytes)
#
# meta = FTLModelMeta()
# meta.config_type = 'keras'
# meta.nn_define = json.dumps(nn_define)
